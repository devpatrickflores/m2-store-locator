<div class="store-locator">
    <div class="store-locator-left">
        <div class="store-locator-search">
            <img src="/media/icons/locator-icon.svg" alt="Store icon" />
            <div class="search-text">Find your closest store</div>
            <div class="search-box-wrap">
                <div class="search-icon">
                    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="900.000000pt" height="900.000000pt"
                        viewBox="0 0 900.000000 900.000000" preserveAspectRatio="xMidYMid meet">
                        <g transform="translate(0.000000,900.000000) scale(0.100000,-0.100000)" fill="#000000"
                            stroke="none">
                            <path
                                d="M3455 8984 c-8 -12 -36 -18 -115 -24 -58 -4 -112 -11 -121 -14 -9 -4 -47 -11 -85 -16 -79 -10 -157 -26 -229 -45 -27 -7 -70 -18 -95 -24 -25 -7 -58 -16 -75 -21 -16 -5 -57 -17 -90 -26 -33 -9 -64 -20 -70 -25 -5 -5 -20 -9 -33 -9 -13 0 -36 -6 -50 -14 -15 -8 -47 -22 -72 -31 -25 -9 -57 -23 -72 -31 -14 -8 -35 -14 -46 -14 -11 0 -25 -7 -32 -15 -7 -8 -17 -15 -23 -15 -16 0 -132 -55 -231 -109 -32 -18 -81 -44 -108 -59 -64 -35 -72 -40 -143 -87 -33 -21 -69 -44 -80 -51 -41 -22 -332 -248 -405 -312 -86 -76 -247 -237 -334 -332 -54 -59 -326 -413 -326 -424 0 -3 -19 -33 -43 -68 -24 -35 -46 -70 -50 -78 -4 -8 -15 -28 -25 -45 -65 -107 -182 -340 -182 -362 0 -6 -7 -16 -15 -23 -8 -7 -15 -21 -15 -32 0 -11 -6 -32 -14 -46 -8 -15 -22 -47 -31 -72 -9 -25 -23 -57 -31 -72 -8 -14 -14 -37 -14 -50 0 -13 -4 -28 -9 -34 -5 -5 -16 -36 -25 -69 -9 -33 -21 -73 -26 -90 -5 -16 -14 -50 -21 -75 -6 -25 -17 -67 -24 -95 -19 -72 -35 -150 -45 -229 -5 -38 -12 -76 -16 -85 -17 -43 -28 -258 -27 -561 0 -381 16 -571 59 -726 8 -28 14 -65 14 -82 0 -17 5 -43 11 -59 7 -15 15 -46 20 -68 4 -22 15 -62 23 -90 9 -27 22 -72 30 -100 26 -88 62 -188 82 -227 8 -14 14 -35 14 -46 0 -11 7 -25 15 -32 8 -7 15 -21 15 -31 0 -10 13 -45 29 -76 15 -32 45 -92 65 -133 56 -116 115 -219 229 -405 39 -63 260 -349 313 -404 34 -36 75 -82 91 -102 38 -48 97 -106 218 -214 55 -49 117 -105 137 -124 20 -18 59 -48 86 -66 27 -17 57 -39 68 -49 26 -23 183 -136 189 -136 3 0 33 -19 68 -43 34 -24 83 -53 107 -66 25 -13 72 -38 105 -56 67 -38 138 -73 222 -111 97 -43 116 -52 163 -69 25 -10 57 -23 72 -31 14 -8 33 -14 42 -14 8 0 30 -6 48 -14 51 -21 99 -37 138 -46 19 -4 49 -13 65 -18 93 -32 133 -42 161 -42 18 0 45 -7 60 -15 16 -8 45 -15 64 -15 20 0 62 -7 93 -15 32 -8 71 -15 87 -15 16 0 62 -7 102 -16 106 -22 825 -22 911 1 32 8 77 15 100 15 48 0 181 24 248 45 26 8 60 15 75 15 16 0 49 6 74 14 25 8 72 22 105 32 33 9 69 21 80 27 11 6 36 14 55 18 40 8 75 20 180 62 127 50 185 75 280 122 192 94 309 161 432 246 15 11 30 19 33 19 3 0 69 47 145 105 77 58 147 108 156 112 11 4 328 -306 1127 -1105 612 -610 1128 -1118 1147 -1128 66 -34 105 -44 180 -44 86 0 145 18 206 61 50 37 102 106 115 154 6 20 16 35 24 35 12 0 15 18 15 90 0 73 -3 90 -15 90 -8 0 -18 12 -21 27 -4 16 -18 46 -32 68 -13 22 -522 538 -1129 1147 -797 797 -1104 1111 -1100 1122 4 9 54 79 112 156 58 76 105 142 105 145 0 3 8 18 19 33 96 139 225 374 297 540 75 174 122 297 133 352 4 19 12 44 18 55 6 11 19 47 28 80 9 33 23 80 31 105 8 25 14 58 14 74 0 15 7 49 15 75 21 67 45 200 45 248 0 23 7 68 15 100 23 86 23 805 1 911 -9 40 -16 86 -16 102 0 16 -7 55 -15 87 -8 31 -15 73 -15 93 0 19 -7 48 -15 64 -8 15 -15 42 -15 58 0 27 -11 70 -42 163 -5 17 -14 46 -18 65 -9 39 -25 87 -46 138 -8 18 -14 40 -14 48 0 9 -6 28 -14 42 -8 15 -21 47 -31 72 -17 47 -26 66 -69 163 -38 84 -73 155 -111 222 -18 33 -43 80 -56 105 -13 24 -42 73 -66 107 -24 35 -43 65 -43 68 0 6 -113 163 -136 189 -10 11 -32 42 -50 69 -18 27 -66 86 -106 130 -41 45 -90 100 -109 122 -50 59 -146 155 -188 188 -20 16 -66 57 -102 91 -55 53 -341 274 -404 313 -186 114 -289 173 -405 229 -41 20 -101 50 -133 65 -31 16 -66 29 -76 29 -10 0 -24 7 -31 15 -7 8 -21 15 -32 15 -11 0 -32 6 -46 14 -38 20 -138 56 -225 81 -26 8 -71 21 -100 30 -28 9 -70 20 -92 24 -22 5 -53 13 -68 20 -16 6 -42 11 -59 11 -17 0 -54 6 -82 14 -70 20 -183 37 -295 45 -70 6 -97 12 -106 24 -11 15 -44 17 -326 17 -277 0 -315 -2 -324 -16z m540 -703 c88 -7 185 -16 215 -22 30 -5 87 -14 127 -19 40 -4 78 -12 85 -16 7 -4 30 -11 53 -15 111 -21 285 -73 348 -105 16 -8 36 -14 46 -14 9 0 26 -7 37 -15 10 -8 27 -15 36 -15 9 0 56 -20 105 -43 48 -24 111 -54 138 -67 28 -13 78 -41 113 -62 34 -21 64 -38 67 -38 3 0 34 -20 71 -45 36 -25 67 -45 70 -45 12 0 230 -171 325 -256 127 -112 399 -406 399 -429 0 -4 17 -28 38 -54 38 -47 142 -197 142 -206 0 -3 12 -24 27 -48 51 -78 54 -85 140 -267 25 -52 50 -104 55 -115 6 -11 15 -33 19 -50 8 -30 19 -61 60 -165 11 -30 24 -73 28 -95 4 -23 11 -47 16 -55 5 -8 12 -32 16 -55 4 -22 12 -58 18 -80 25 -99 41 -186 41 -227 0 -25 7 -67 15 -94 12 -39 15 -114 15 -367 0 -196 -4 -326 -10 -337 -6 -11 -13 -47 -15 -82 -9 -97 -49 -296 -77 -373 -6 -16 -13 -48 -16 -70 -2 -22 -11 -49 -18 -60 -8 -11 -14 -29 -14 -40 0 -11 -6 -29 -14 -40 -7 -11 -16 -31 -19 -45 -11 -53 -110 -282 -159 -370 -4 -8 -13 -26 -18 -39 -6 -13 -21 -38 -33 -55 -27 -37 -43 -64 -56 -92 -49 -108 -285 -408 -451 -574 -166 -166 -466 -402 -574 -451 -28 -13 -55 -29 -92 -56 -17 -12 -42 -27 -55 -33 -13 -5 -31 -14 -39 -18 -88 -49 -317 -148 -370 -159 -14 -3 -34 -12 -45 -19 -11 -8 -29 -14 -40 -14 -11 0 -29 -6 -40 -14 -11 -7 -38 -16 -60 -18 -22 -3 -53 -10 -70 -16 -77 -28 -276 -68 -373 -77 -35 -2 -71 -9 -82 -15 -11 -6 -141 -10 -337 -10 -253 0 -328 3 -367 15 -27 8 -69 15 -94 15 -41 0 -128 16 -227 41 -22 6 -58 14 -80 18 -23 4 -47 11 -55 16 -8 5 -32 12 -55 16 -22 4 -58 14 -80 23 -22 8 -65 25 -95 36 -30 12 -69 25 -85 29 -17 4 -39 13 -50 19 -11 5 -63 30 -115 55 -182 86 -189 89 -267 140 -24 15 -45 27 -48 27 -9 0 -159 104 -206 142 -26 21 -50 38 -54 38 -9 0 -90 69 -221 188 -206 189 -403 428 -544 662 -54 88 -90 153 -110 195 -13 28 -43 90 -67 138 -24 48 -43 94 -43 102 0 7 -6 26 -14 42 -13 26 -25 55 -60 151 -22 61 -62 210 -75 277 -4 23 -11 46 -15 53 -4 7 -12 45 -16 85 -5 40 -14 97 -19 127 -12 67 -34 352 -33 435 1 130 24 403 38 457 7 32 14 75 14 97 0 36 11 84 46 191 8 25 14 58 14 73 0 16 5 38 12 50 6 12 15 35 19 52 7 29 17 55 59 165 12 30 24 64 27 75 3 11 26 63 51 115 25 52 52 111 61 130 9 19 27 53 41 75 45 73 49 80 59 100 5 11 21 37 35 58 14 21 26 40 26 43 0 4 50 74 119 164 10 14 36 48 58 76 37 51 169 200 228 259 59 59 208 191 259 228 28 22 62 48 76 58 90 69 160 119 164 119 3 0 22 12 43 26 21 14 47 30 58 35 21 10 36 19 100 60 22 14 64 35 92 47 29 13 74 34 99 47 26 14 53 25 59 25 7 0 18 6 24 14 6 8 24 16 39 19 15 3 45 12 67 21 22 8 65 25 95 36 30 12 69 25 85 29 17 4 40 13 52 19 12 7 34 12 50 12 15 0 48 6 73 14 108 35 155 46 192 46 22 0 63 6 91 14 29 8 120 17 204 21 84 4 165 10 180 15 29 9 38 9 298 -9z">
                            </path>
                        </g>
                    </svg>
                </div>
                <input id="search-box" type="text" placeholder="Enter postcode or suburb">
            </div>
        </div>
        <div id="store-results" style="margin-top: 20px;">
            <ul id="store-list"></ul>
        </div>
    </div>

    <div class="store-locator-right">
        <div class="store-image">
            <img src="/media/wysiwyg/store-image.jpg" alt="Store Image" />
        </div>
        <div class="store-map" style="display: none;">
            <div id="map" style="height: 500px; width: 100%; position: relative;"></div>
        </div>
    </div>

    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDfPdThC9bAVP590qpYhG4cehinkPiT_Uw&libraries=places,geometry&callback=initMap"
        async defer></script>
    <script>
        var map;
        var infowindow;
        var markers = [];
        var storeData = [
            <?php $stores = $block->getStores(); ?>
        <?php if ($stores->getSize()): ?>
                            <?php foreach ($stores as $index => $store): ?>
                                                {
                        store_name: '<?php echo addslashes($store->getStoresName()); ?>',
                        latitude: <?php echo $store->getStoresLat(); ?>,
                        longitude: <?php echo $store->getStoresLong(); ?>,
                        address: '<?php echo addslashes($store->getStoresAddress()); ?>',
                        store_url: '/stores/index/view/id/<?php echo $store['entity_id']; ?>'
                    }<?php if ($index < $stores->getSize() - 1): ?>, <?php endif; ?>
                                                <?php echo $store->getStoresEntityId(); ?>
                            <?php endforeach; ?>
        <?php endif; ?>
        ];

        function initMap() {
            var lightestGrayMapStyles = [
                {
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#eeeeee"
                        }
                    ]
                },
                {
                    "elementType": "labels.icon",
                    "stylers": [
                        {
                            "visibility": "off"
                        }
                    ]
                },
                {
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#666666"
                        }
                    ]
                },
                {
                    "elementType": "labels.text.stroke",
                    "stylers": [
                        {
                            "color": "#ffffff"
                        }
                    ]
                },
                {
                    "featureType": "administrative",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "visibility": "off"
                        }
                    ]
                },
                {
                    "featureType": "administrative.country",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#999999"
                        }
                    ]
                },
                {
                    "featureType": "administrative.land_parcel",
                    "elementType": "labels",
                    "stylers": [
                        {
                            "visibility": "off"
                        }
                    ]
                },
                {
                    "featureType": "administrative.locality",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#888888"
                        }
                    ]
                },
                {
                    "featureType": "poi",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#666666"
                        }
                    ]
                },
                {
                    "featureType": "poi.park",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#dddddd"
                        }
                    ]
                },
                {
                    "featureType": "poi.park",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#888888"
                        }
                    ]
                },
                {
                    "featureType": "road",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#ffffff"
                        }
                    ]
                },
                {
                    "featureType": "road",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#666666"
                        }
                    ]
                },
                {
                    "featureType": "road.arterial",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#ffffff"
                        }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#f5f5f5"
                        }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#666666"
                        }
                    ]
                },
                {
                    "featureType": "transit",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#666666"
                        }
                    ]
                },
                {
                    "featureType": "water",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#e0e0e0"
                        }
                    ]
                },
                {
                    "featureType": "water",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#888888"
                        }
                    ]
                }
            ];

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 11,
                center: { lat: -37.81, lng: 144.96 },
                styles: lightestGrayMapStyles,
                zoomControl: true,       // Show zoom controls
                zoomControlOptions: {
                    position: google.maps.ControlPosition.TOP_RIGHT
                },
                mapTypeControl: false,   // Hide map type control
                streetViewControl: false,// Hide Street View control
                fullscreenControl: false // Hide fullscreen control
            });

            infowindow = new google.maps.InfoWindow();

            // Initialize markers
            storeData.forEach(function (store) {
                var latLng = new google.maps.LatLng(store.latitude, store.longitude);
                var markerIconUrl = '/media/icons/locator-icon.png';
                var iconSize = new google.maps.Size(38, 44);
                var iconScaledSize = new google.maps.Size(38, 44);


                var mapMarker = new google.maps.Marker({
                    position: latLng,
                    map: map,
                    icon: {
                        url: markerIconUrl,
                        size: iconSize,
                        scaledSize: iconScaledSize
                    },
                    title: store.store_name
                });

                google.maps.event.addListener(mapMarker, 'click', (function (mapMarker, store) {
                    return function () {
                        infowindow.setContent('<div><strong>' + store.store_name + '</strong><br>' + store.address + '</div>');
                        infowindow.open(map, mapMarker);
                    }
                })(mapMarker, store));

                markers.push(mapMarker);
            });

            var searchBox = new google.maps.places.Autocomplete(document.getElementById('search-box'), {
                types: ['(regions)'],
                componentRestrictions: { country: 'au' }
            });

            searchBox.addListener('place_changed', function () {
                var place = searchBox.getPlace();

                if (!place.geometry) {
                    console.log("Returned place contains no geometry");
                    return;
                }

                var userLocation = place.geometry.location;
                var userLatLng = new google.maps.LatLng(userLocation.lat(), userLocation.lng());

                // Clear old markers
                markers.forEach(function (marker) {
                    marker.setMap(null);
                });
                markers = [];

                // Filter and display nearby stores
                var nearbyStores = storeData
                    .map(store => {
                        var storeLatLng = new google.maps.LatLng(store.latitude, store.longitude);
                        var distance = google.maps.geometry.spherical.computeDistanceBetween(userLatLng, storeLatLng) / 1000; // distance in km
                        return { ...store, distance: distance };
                    })
                    .filter(store => store.distance <= 10)
                    .sort((a, b) => a.distance - b.distance);

                var storeList = document.getElementById('store-list');
                storeList.innerHTML = '';

                nearbyStores.forEach(store => {
                    var listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <a href="${store.store_url}">
                        <strong>${store.store_name}</strong><br>
                        ${store.address}<br>
                        ${store.distance.toFixed(2)} km
                        </a>
                    `;
                    storeList.appendChild(listItem);

                    var latLng = new google.maps.LatLng(store.latitude, store.longitude);

                    var markerIconUrl = '/media/icons/locator-icon.png';
                    var iconSize = new google.maps.Size(38, 44);
                    var iconScaledSize = new google.maps.Size(38, 44);


                    var mapMarker = new google.maps.Marker({
                        position: latLng,
                        map: map,
                        icon: {
                            url: markerIconUrl,
                            size: iconSize,
                            scaledSize: iconScaledSize
                        },
                        title: store.store_name
                    });

                    google.maps.event.addListener(mapMarker, 'click', (function (mapMarker, store) {
                        return function () {
                            infowindow.setContent('<div><strong>' + store.store_name + '</strong><br>' + store.address + '</div>');
                            infowindow.open(map, mapMarker);
                        }
                    })(mapMarker, store));

                    markers.push(mapMarker);
                });

                if (nearbyStores.length > 0) {
                    // map.setCenter(userLatLng);
                } else {
                    alert("No HARLI + HARPA stores found within 10 km radius.");
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            var searchBox = document.querySelector('#search-box');
            var searchMap = document.querySelector('.store-map');
            var storeWrapper = document.querySelector('.store-image');

            if (searchBox && storeWrapper && searchMap) {
                searchBox.addEventListener('input', function () {
                    storeWrapper.style.height = '0';
                    searchMap.style.display = 'block';
                });
            }
        });
    </script>

    <style>
        #map {
            height: 500px;
            width: 100%;
            position: relative;
        }

        .gm-style-iw-c {
            position: relative;
        }

        .gm-style .gm-control-active {
            top: 10px;
            right: 10px;
        }

        body.stores-index-index .columns .column.main {
            width: 100%;
            margin: auto;
            display: table;
            padding-bottom: 0;
        }

        body.stores-index-index .page-wrapper {
            min-height: initial;
        }

        body.stores-index-index .store-locator {
            display: flex;
            width: 100%;
            justify-content: space-around;
            align-items: center;
        }

        body.stores-index-index .store-locator .store-locator-left {
            max-height: 290px;
            height: 100%;
            padding-right: 15px;
            overflow-x: hidden;
            overflow-y: auto;
        }

        body.stores-index-index .store-locator .store-locator-left .store-locator-search img {
            width: 55px;
            height: 55px;
            text-align: center;
            display: table;
            margin: auto;
            margin-bottom: 20px;
        }

        body.stores-index-index .store-locator .store-locator-left .search-text {
            font-family: 'Avenir';
            font-size: 24px;
            font-weight: 800;
            letter-spacing: 3px;
            text-align: center;
            margin-bottom: 10px;
            text-transform: capitalize;
        }

        body.stores-index-index .store-locator .store-locator-left .search-box-wrap {
            position: relative;
        }

        body.stores-index-index .store-locator .store-locator-left .search-box-wrap .search-icon {
            position: absolute;
            top: 14px;
            left: 14px;
        }

        body.stores-index-index .store-locator .store-locator-left .search-box-wrap .search-icon svg {
            width: 17px;
            height: 17px;
        }

        body.stores-index-index .store-locator .store-locator-left .search-box-wrap #search-box {
            height: 45px;
            width: 320px;
            padding: 0 40px;
            border: 1px solid #111;
            outline: 0;
            box-shadow: none;
        }

        body.stores-index-index .store-locator .store-locator-left #store-list {
            padding-left: 2px;
            list-style: none;
        }

        body.stores-index-index .store-locator .store-locator-left #store-list li {
            padding: 20px;
            border: 1px solid #ddd;
        }

        body.stores-index-index .store-locator .store-locator-left #store-list li a {
            text-decoration: none;
            color: #111;
        }

        body.stores-index-index .store-locator .store-locator-right .store-image img {
            width: 100%;
            min-width: 800px;
        }

        body.stores-index-index .store-locator .store-locator-right .store-wrapper {
            display: flex;
        }

        body.stores-index-index .store-locator .store-locator-right .store-image {
            display: flex;
        }

        body.stores-index-index .store-locator .store-locator-left::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        body.stores-index-index .store-locator .store-locator-left::-webkit-scrollbar-button:start:decrement,
        body.stores-index-index .store-locator .store-locator-left::-webkit-scrollbar-button:end:increment {
            display: block;
            height: 10px;
        }

        body.stores-index-index .store-locator .store-locator-left::-webkit-scrollbar-button:vertical:increment {
            background-color: #fff;
        }

        body.stores-index-index .store-locator .store-locator-left::-webkit-scrollbar-track-piece {
            background-color: #eee;
            -webkit-border-radius: 3px;
        }

        body.stores-index-index .store-locator .store-locator-left::-webkit-scrollbar-thumb:vertical {
            height: 50px;
            background-color: #ccc;
            -webkit-border-radius: 3px;
        }

        body.stores-index-index .store-locator .store-locator-left::-webkit-scrollbar-thumb:horizontal {
            width: 50px;
            background-color: #ccc;
            -webkit-border-radius: 3px;
        }
    </style>
</div>